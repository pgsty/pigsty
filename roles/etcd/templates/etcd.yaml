sources:
  etcd_raw:
    type: file
    read_from: {{ vector_read_from|default('beginning') }}
    include: [ "/var/log/etcd.log" ]
    ignore_not_found: true

transforms:
  etcd_logs:
    type: remap
    inputs: [etcd_raw]
    source: |
      .ip = "{{ inventory_hostname }}"
      .src = "etcd"
      .ins = "{{ etcd_cluster }}-{{ etcd_seq }}"
      .cls = "{{ etcd_cluster }}"
      ._time = format_timestamp(.timestamp, "%Y-%m-%dT%H:%M:%S%.fZ") ?? now()
      parsed, err = parse_json(.message)
      if err == null {
        ts, ts_err = parse_timestamp(to_string(parsed.ts) ?? "", "%Y-%m-%dT%H:%M:%S%.fZ")
        if ts_err == null { ._time = format_timestamp(ts, "%Y-%m-%dT%H:%M:%S%.fZ") ?? ._time }
        .level = upcase(to_string(parsed.level) ?? "INFO")
        del(parsed.level)
        del(parsed.ts)
      } else {
        .level = "INFO"
      }
      del(.source_type);del(.file);del(.host);del(.timestamp)
