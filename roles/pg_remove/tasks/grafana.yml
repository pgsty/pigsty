---
#--------------------------------------------------------------#
# Remove postgres datasource from Grafana              [grafana]
#--------------------------------------------------------------#
# only remove those registered databases
- name: remove postgres datasource from grafana
  ignore_errors: yes
  delegate_to: "{{ admin_ip }}"
  when: item.register_data_source is not defined or item.register_data_source|bool
  shell: |
    curl -X DELETE "{{ endpoint }}/api/datasources/name/{{ ds_name }}" -u "{{ grafana_user }}:{{ grafana_pass }}" -H 'Content-Type: application/json'
  args: { executable: /bin/bash }
  vars:
    ds_name: "{{ pg_cluster }}-{{ pg_seq }}.{{ item.name }}"
    endpoint: "http://{{ infra_portal.grafana.endpoint|replace('${admin_ip}' ,admin_ip) }}"
    grafana_user: "{{ grafana_admin_username|default('admin') }}"
    grafana_pass: "{{ grafana_admin_password|default('pigsty') }}"
  with_items: "{{ pg_databases }}"
...