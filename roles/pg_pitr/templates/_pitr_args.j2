{# ============================================================== #}
{# Shared PITR Arguments Template                                 #}
{# This template generates pgbackrest restore command arguments   #}
{# ============================================================== #}
{% macro abort(error) %}{{ None['[ERROR] ' ~ error][0] }}{% endmacro %}

{% set p = pg_pitr | default({}) %}
{% set pitr_repo       = p.repo      | default(pgbackrest_repo[pgbackrest_method]) %}
{% set pitr_cluster    = p.cluster   | default(pg_cluster) | string %}
{% set pitr_type       = p.type      | default('default')  | string %}
{% set pitr_action     = p.action    | default('pause')    | string %}
{% set pitr_set        = p.set       | default('latest')   | string %}
{% set pitr_timeline   = p.timeline  | default('latest')   | string %}
{% set pitr_data       = p.data      | default(pg_data)    | string %}

{# Build command arguments list #}
{% set cmd_args = [] %}
{% set cmd_args = cmd_args + [ '--config=/pg/conf/pitr.conf' ] %}
{% set cmd_args = cmd_args + [ '--stanza=' + pitr_cluster ] %}

{# Validate pitr type #}
{% if pitr_type not in ['default','immediate','time','lsn','xid','name'] %}
{{ abort("invalid pg_pitr.type: " + pitr_type) }}
{% endif %}

{# Handle --pg1-path if custom data directory is specified #}
{% if pitr_data != pg_data %}
{% set cmd_args = cmd_args + ['--pg1-path=' + pitr_data] %}
{% endif %}

{# Handle force option #}
{% if p.force is defined and p.force|bool %}
{% set cmd_args = cmd_args + ['--force'] %}
{% endif %}

{# ============================================================== #}
{# Recovery Target: time                                          #}
{# ============================================================== #}
{% if p.time is defined %}
{% if p.lsn is defined or p.xid is defined or p.name is defined or p.type|default('time') != 'time' %}
{{ abort("invalid pitr target provided! time conflicts with other targets") }}
{% endif %}
{# Validate time format: must be UTC format like 2025-01-01 10:00:00+00 #}
{% if not p.time is match("^\\d{4}-\\d{2}-\\d{2}[ T]\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?\\+00(:00)?$") %}
{{ abort("invalid time format: " + p.time + ". Expected UTC format: YYYY-MM-DD HH:MM:SS+00 (e.g., 2025-01-01 10:00:00+00)") }}
{% endif %}
{% set pitr_type = 'time' %}
{% set pitr_target = p.time %}
{% set cmd_args = cmd_args + ['--type=time'] %}
{% set cmd_args = cmd_args + ['--target="' + p.time + '"'] %}
{% endif %}

{# ============================================================== #}
{# Recovery Target: name (restore point)                          #}
{# ============================================================== #}
{% if p.name is defined %}
{% if p.lsn is defined or p.xid is defined or p.time is defined or p.type|default('name') != 'name' %}
{{ abort("invalid pitr target provided! name conflicts with other targets") }}
{% endif %}
{% set pitr_type = 'name' %}
{% set cmd_args = cmd_args + ['--type=name'] %}
{% set cmd_args = cmd_args + ['--target="' + p.name + '"'] %}
{% endif %}

{# ============================================================== #}
{# Recovery Target: xid (transaction ID)                          #}
{# ============================================================== #}
{% if p.xid is defined %}
{% if p.lsn is defined or p.name is defined or p.time is defined or p.type|default('xid') != 'xid' %}
{{ abort("invalid pitr target provided! xid conflicts with other targets") }}
{% endif %}
{% if p.xid|int is not number or p.xid|int <= 0 or p.xid|int >= 4294967296 %}
{{ abort("invalid XID: " + p.xid|string + ". XID must be a positive 32-bit integer (0 < xid < 4294967296)") }}
{% endif %}
{% set pitr_type = 'xid' %}
{% set cmd_args = cmd_args + ['--type=xid'] %}
{% set cmd_args = cmd_args + ['--target=' + p.xid|string] %}
{% endif %}

{# ============================================================== #}
{# Recovery Target: lsn (Log Sequence Number)                     #}
{# ============================================================== #}
{% if p.lsn is defined %}
{% if p.xid is defined or p.name is defined or p.time is defined or p.type|default('lsn') != 'lsn' %}
{{ abort("invalid pitr target provided! lsn conflicts with other targets") }}
{% endif %}
{% if not p.lsn|upper is match("[0-9A-F]{1,8}/[0-9A-F]{1,8}") %}
{{ abort("invalid LSN format: " + p.lsn + ". Expected format: [0-9A-F]{1,8}/[0-9A-F]{1,8}") }}
{% endif %}
{% set pitr_type = 'lsn' %}
{% set cmd_args = cmd_args + ['--type=lsn'] %}
{% set cmd_args = cmd_args + ['--target=' + p.lsn|upper] %}
{% endif %}

{# ============================================================== #}
{# Recovery Target: immediate (consistent state only)             #}
{# ============================================================== #}
{% if p.type is defined and p.type == 'immediate' %}
{% if p.xid is defined or p.name is defined or p.time is defined or p.lsn is defined %}
{{ abort("invalid pitr target provided! immediate conflicts with other targets") }}
{% endif %}
{% set pitr_type = 'immediate' %}
{% set cmd_args = cmd_args + ['--type=immediate'] %}
{% endif %}

{# ============================================================== #}
{# Recovery Target: default (end of archive stream)               #}
{# ============================================================== #}
{% if p.time is not defined and p.xid is not defined and p.name is not defined and p.lsn is not defined and (p.type is not defined or p.type == 'default') %}
{% set pitr_type = 'default' %}
{% endif %}

{# ============================================================== #}
{# Additional Options                                             #}
{# ============================================================== #}
{% if p.exclusive is defined and p.exclusive|bool %}
{% set cmd_args = cmd_args + ['--target-exclusive'] %}
{% endif %}

{% if pitr_action not in ['promote','pause','shutdown'] %}
{{ abort("invalid pg_pitr.action: " + pitr_action) }}
{% else %}
{% if pitr_action != 'pause' and pitr_type in ['immediate','time','name','xid','lsn'] %}
{% set cmd_args = cmd_args + ['--target-action=' + pitr_action] %}
{% endif %}
{% endif %}

{% if pitr_timeline|string != 'latest' %}
{% set cmd_args = cmd_args + ['--target-timeline=' + pitr_timeline|string] %}
{% endif %}

{% if pitr_set != 'latest' %}
{% set cmd_args = cmd_args + ['--set=' + pitr_set] %}
{% endif %}
