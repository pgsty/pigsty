#!/usr/bin/env bash
set -uo pipefail
#==============================================================#
# File      :   pg-restore
# Desc      :   script to restore pg cluster with pgbackrest
# Time      :   {{ '%Y-%m-%d %H:%M' | strftime }}
# Host      :   {{ pg_instance }} @ {{ inventory_hostname }}:{{ patroni_port }}
# Path      :   /pg/bin/pg-restore
# Deps      :   /usr/bin/pgbackrest, /pg/conf/pitr.conf
# License   :   Apache-2.0 @ https://pigsty.io/docs/about/license/
# Copyright :   2018-2026  Ruohang Feng / Vonng (rh@vonng.com)
#==============================================================#
# https://pgbackrest.org/command.html#command-restore
# https://pgbackrest.org/configuration.html#section-restore
# https://www.postgresql.org/docs/current/runtime-config-wal.html#RUNTIME-CONFIG-WAL-RECOVERY-TARGET

#--------------------------------------------------------------#
# Utils
#--------------------------------------------------------------#
__CN='\033[0m';__CR='\033[0;31m';__CG='\033[0;32m';
__CY='\033[0;33m';__CB='\033[0;34m';__CM='\033[0;35m';
function log_info()  { printf "${__CG}$*${__CN}\n";   }
function log_warn()  { printf "${__CY}$*${__CN}\n";   }
function log_hint()  { printf "${__CB}$*${__CN}\n";   }
function log_line()  { printf "${__CM}[$*] ===========================================${__CN}\n"; }
function log_error() { printf "[${__CR}FAIL${__CN}] ${__CR}$*${__CN}\n"; exit 1; }

{% include '_pitr_args.j2' %}

# run this script as postgres dbsu
DBSU={{ pg_dbsu|default('postgres') }}
if [ "$(whoami)" != "$DBSU" ]; then
    log_error "This script must be run as $DBSU os user"
fi

log_warn "Perform {{ pitr_type }} PITR on {{ pg_cluster }} from stanza {{ pitr_cluster }}"

log_line "1. Stop PostgreSQL"
log_info "   1.1 Pause Patroni (if there are any replicas)"
log_hint "       $ pg pause <cls>  # pause patroni auto failover"
log_info "   1.2 Shutdown Patroni"
log_hint "       $ pt-stop         # sudo systemctl stop patroni"
log_info "   1.3 Shutdown Postgres"
log_hint "       $ pg-stop         # pg_ctl -D {{ pitr_data }} stop -m immediate"
log_hint ""

log_line "2. Perform PITR"
log_info "   2.1 Restore Backup"
log_hint "       $ /usr/bin/pgbackrest {{ cmd_args|join(' ') }} restore"
log_info "   2.2 Start PG to Replay WAL"
log_hint "       $ pg-start        # pg_ctl -D {{ pitr_data }} start"
log_info "   2.3 Validate and Continue"
log_warn "     - If it is not the point you want, goto 2.1"
log_info "     - Otherwise make sure pg-promote then goto 3"
log_hint ""

log_line "3. Restore Primary"
log_info "   3.1 Enable Archive Mode (Restart Required)"
log_hint "       $ psql -c 'ALTER SYSTEM SET archive_mode = on;'"
log_info "   3.2 Restart Postgres to Apply Changes"
log_hint "       $ pg-restart      # pg_ctl -D {{ pitr_data }} restart"
log_info "   3.3 Restart Patroni"
log_hint "       $ pt-restart      # sudo systemctl restart patroni"
log_hint ""

log_warn "WARNING: You are about to perform a Point-In-Time Recovery!"
log_warn "This operation will nuke the existing cluster with new one!"
log_warn "If this is not what you want, Ctrl+C to abort before start!"

# Countdown only if running in interactive terminal
if [ -t 0 ] && [ -t 1 ]; then
    for i in 5 4 3 2 1; do
        printf "\r${__CY}Countdown: $i seconds remaining...${__CN}"
        sleep 1
    done
    printf "\n"
else
    log_info "Non-interactive mode detected, skipping countdown..."
fi
log_warn "Proceeding with PITR operation."

log_line "Restore Begin!"

log_line "1.1 Pause Patroni"
patronictl -c /etc/patroni/patroni.yml pause "{{ pg_cluster }}"

log_line "1.2 Shutdown Patroni"
sudo systemctl stop patroni

log_line "1.3 Shutdown Postgres"
pg_ctl -D "{{ pitr_data }}" stop

{% if p.backup is defined and p.backup|bool %}
log_line "1.4 Backup existing data directory"
if [ -d "{{ pitr_data }}" ]; then
    rm -rf "{{ pitr_data }}-backup" 2>/dev/null || true
    mv "{{ pitr_data }}" "{{ pitr_data }}-backup"
    log_info "Data directory backed up to {{ pitr_data }}-backup"
fi
{% endif %}

log_line "2.1 Perform Restore"
log_hint "$ /usr/bin/pgbackrest {{ cmd_args|join(' ') }} restore"
/usr/bin/pgbackrest {{ cmd_args|join(' ') }} restore
if [ $? -ne 0 ]; then
    log_error "pgbackrest restore failed"
fi

log_line "2.2 Start PG to Replay WAL"
pg_ctl -D "{{ pitr_data }}" start

log_line "Restore Done!"

log_line "What's next?"
log_info "   2.3 Validate Your backup, then make sure promoted "
log_hint "       $ pg-promote"
log_info "   3.1 Enable Archive Mode (Restart Required)"
log_hint "       $ psql -c 'ALTER SYSTEM SET archive_mode = on;'"
log_info "   3.2 Restart Postgres to Apply Changes"
log_hint "       $ pg-restart      # pg_ctl -D {{ pitr_data }} restart"
log_info "   3.3 Restart Patroni"
log_hint "       $ pt-restart      # sudo systemctl restart patroni"
log_info "   4.x Reinit other replicas, if you have"
